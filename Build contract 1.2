QUANTDESK DATAHUB v1.2 — BUILD CONTRACT (LOCKED)
Document ID: QD-DH-BC-001
Version: 1.2
Status: LOCKED FOR IMPLEMENTATION
Date (Europe/Bratislava): 2026-02-02

====================================================================
PARTIES
====================================================================
- Owner / Operator: Marek Baran ("Mark")
- Engineering/Delivery Agent: Ava — GPT-5.2 Thinking (ChatGPT)

====================================================================
PURPOSE
====================================================================
Build and deliver a production-grade “DataHub” that converts an old Windows laptop
into a 24/7 unattended market-data hub with:

1) Main Server (Port 8000) — serves authenticated Web Control Panel
2) Collector (exchange feed ingestion + raw capture + deterministic frame production)
3) Frame API (Port 8010) — serves deterministic 200ms frames (live + replay)

The DataHub MUST:
- Run 24/7 unattended.
- Auto-start on boot (even with no user logged in).
- Auto-recover from Wi-Fi disconnects, process crashes, and stalled feeds.
- Store raw market data and precomputed frames suitable for deterministic replay.
- Provide an authenticated iPad-accessible Web Control Panel via Tailscale.
- Provide a professional Desktop Control Panel UI (password-gated) for local operation.
- Be delivered as a single .zip with a Windows GUI “one-button” installer wizard.

====================================================================
PRIMARY PARITY GOAL (SCOPE-TRUE)
====================================================================
The DataHub’s stored truth + replay interface must support “Bookmap-style parity”
reconstruction downstream by ensuring:
- Deterministic raw capture and deterministic frame generation.
- Stable and unambiguous history selection by (exchange/market/symbol/time).
- Output frames at fixed cadence (200 ms) with consistent schema.
Note: Visual parity is implemented in the later PWA; DataHub provides the truth and
replay substrate.

====================================================================
NON-NEGOTIABLE TECHNOLOGY DECISION (v1.2 CHANGE)
====================================================================
NO PYTHON IS PERMITTED ANYWHERE in the delivered runtime or installer flow.

Implementation language/runtime:
- Core runtime MUST be implemented in C# on Microsoft .NET (target: .NET 10 LTS).
- Desktop Control Panel MUST be a native Windows desktop app (WPF recommended).
- Web Control Panel and Frame API MUST be implemented using ASP.NET Core / Kestrel.

Reference facts:
- .NET 10 is an LTS release with support lifecycle published by Microsoft.
  (This contract pins to .NET 10 LTS for production stability.)

====================================================================
SCOPE (IN)
====================================================================
A) Supported exchanges/markets (v1)
- Exchange selection: MEXC only (v1)
- Markets: MEXC Futures + MEXC Spot

B) Symbol selection UX
- Futures: dropdown lists ALL MEXC futures symbols.
- Spot: editable favorites list, initialized to: BTC, ETH, FLOKI.

C) Switching behavior
- Switching market/symbol restarts ONLY the collector.
- Switching must NEVER delete existing data.
- Each exchange/market/symbol writes to its own dedicated folder.
- Replay must be able to target the selected history by source.

D) Storage format and retention
- Raw data format: gzip-compressed JSONL.
- Rotation: UTC hourly.
- Retention: exactly 30 UTC calendar days with automatic deletion of older data.
- Frames: precomputed and stored to disk (not only on-demand).
- Frame cadence: 200 ms.

E) Networking / Access
- Bind services to Tailscale interface ONLY (100.x IP).
- Remote access for iPad via Tailscale VPN (already installed).
- Windows Firewall rules must be created and scoped to Tailscale interface for:
  - 8000 (Main Server + Web Control Panel)
  - 8010 (Frame API)

F) Authentication & Control
- One master password controls EVERYTHING:
  - Web Control Panel login (iPad)
  - Desktop Control Panel unlock (local)
- Password policy:
  - Minimum 8 characters
  - Must be typed twice during install (confirmation)
  - No password reset mechanism
  - No password change from iPad
  - Password change requires reinstall/uninstall path
- Password storage:
  - MUST be stored as a secure hash (never plaintext).

G) Installer UX
- Delivered as single .zip.
- Online install allowed (wizard may download dependencies).
- Installer must be a Windows GUI wizard with “one-button” straight-through flow.
- Installer must:
  - Install dependencies (including .NET runtime if missing)
  - Create all folders
  - Configure binding to Tailscale interface
  - Configure firewall rules (Tailscale-scoped)
  - Configure 24/7 power settings (no sleep/hibernate; keep network active;
    lid close = do nothing)
  - Configure auto-start at boot even without login (Scheduled Task approach)
  - Configure crash-restart (Task + internal watchdog)
  - Configure daily self-check + scheduled restart window (e.g., 04:00 UTC)
  - Configure Windows Update settings to reduce surprise restarts (active hours/
    restart controls where possible)
  - Guide BIOS/UEFI setting “Restore on AC power loss” (manual step)
  - Create Desktop shortcut + Start Menu entry for Control Panel
  - After setup, auto-verify by launching the web control login page

H) Desktop Control Panel (Professional)
- Launch after install
- Auto-launch on login
- Must display:
  - Feed status (connected/disconnected)
  - Storage status (current paths, write activity)
  - Rotation/retention status
  - Frame engine status (last frame time, cadence)
  - Copy/paste-ready Tailscale URLs for:
    - Web Control (8000)
    - Frame API (8010)
- Must provide controls:
  - Start / Stop DataHub
  - Restart collector
  - Market selector (MEXC Futures / MEXC Spot)
  - Symbol selector (per rules above)
  - Launch Uninstall Wizard
- Closing UI must NOT stop background DataHub.

I) Web Control Panel (Authenticated only)
- Served on the same port as main server: 8000.
- No separate unauthenticated /status page.
- Includes status + diagnostics + controls.
- Must include “tail last N errors” view from error ledger.

J) Uninstall Wizard
Must fully remove:
- Tasks/services
- Firewall rules
- Shortcuts and startup entries
- Program files
Must optionally delete data under C:\DataHub (prompt user).

====================================================================
SCOPE (OUT) — EXPLICITLY NOT REQUIRED FOR v1
====================================================================
- Public internet exposure without VPN (no port-forwarding, no public reverse proxy).
- Multi-exchange support beyond MEXC (connectors for other exchanges can be added later).
- PWA/WebGL heatmap renderer (built later in Replit).
- L3/full order book beyond available L2 feed.

====================================================================
TARGET MACHINE (IMPLEMENTATION ENVIRONMENT)
====================================================================
- Host: Acer Aspire 5333
- OS: Windows 10 Home 22H2 (OS Build 19045.6466)
- CPU: Intel Celeron P4600 @ 2.00 GHz
- RAM: 4.00 GB DDR3
- Storage: 447 GB total; ~311 GB free
- Network: Wi-Fi
- Power: Plugged in 24/7
- Privileges: Admin CMD available

====================================================================
FIXED PORTS (LOCKED)
====================================================================
- Main Server + Web Control Panel: 8000
- Frame API: 8010

====================================================================
FIXED DATA PATH (LOCKED)
====================================================================
- Base: C:\DataHub
- Raw hierarchy:
  C:\DataHub\raw\<exchange>\<market>\<symbol>\YYYY\MM\DD\<HH>*.jsonl.gz
- Frames hierarchy:
  C:\DataHub\frames\<exchange>\<market>\<symbol>\YYYY\MM\DD\<HH>*  (format TBD, hierarchy locked)

====================================================================
TIME STANDARD (LOCKED)
====================================================================
- UTC rotation and UTC retention windows.

====================================================================
RELIABILITY & WATCHDOGS (LOCKED REQUIREMENTS)
====================================================================
- Collector must reconnect on any disconnect.
- A stall watchdog must detect lack of fresh data and trigger reconnection/restart.
- Outer supervisor must restart the DataHub if the process exits (Scheduled Task restart policy).
- Daily self-check + scheduled restart window must run even if healthy.

====================================================================
POWER & LID BEHAVIOR (LOCKED)
====================================================================
- No sleep / no hibernate.
- Keep network active.
- Lid close: Do nothing.

====================================================================
BIOS/UEFI (LOCKED INSTALLER GUIDANCE)
====================================================================
- Installer must guide enabling: “Restore on AC power loss”.

====================================================================
WINDOWS UPDATE HARDENING (LOCKED)
====================================================================
- Configure to reduce surprise restarts (active hours/restart controls where possible).

====================================================================
SECURITY (LOCKED)
====================================================================
- Bind to Tailscale interface only (100.x).
- Firewall allowlist for Tailscale interface only.
- Password-based authentication; store password as secure hash, not plaintext.
- No unauthenticated control endpoints.

====================================================================
ACCEPTANCE TESTS (DEFINITION OF DONE)
====================================================================
A0. INSTALLER INTEGRITY
- Single .zip delivered.
- Running installer launches Windows GUI wizard and completes without manual editing of code.
- After install, Desktop shortcut + Start Menu entry exist and function.
- Confirm DataHub runtime runs without Python being installed.

A1. AUTO-START & BOOT RECOVERY
- Reboot test: after Windows restart, DataHub background components start automatically without user login.
- If auto-login is enabled, the Desktop Control Panel auto-launches on login.
- Control Panel shows “running” state within a bounded startup time.

A2. NETWORK RECOVERY
- Simulate Wi-Fi disconnect → collector enters reconnect loop.
- Restore Wi-Fi → collector reconnects and resumes writing data.
- No operator intervention required.

A3. RAW STORAGE CONTRACT
- Raw data files appear under:
  C:\DataHub\raw\mexc\<spot|futures>\<symbol>\YYYY\MM\DD\
- Files are gzip JSONL.
- Rotation occurs on UTC hour boundaries.

A4. RETENTION CONTRACT
- Data older than exactly 30 UTC calendar days is deleted automatically.
- Deletion is scoped correctly per folder hierarchy.

A5. FRAME GENERATION CONTRACT
- Frame cadence is 200 ms.
- Frames are stored on disk under frames hierarchy.
- Frame API returns frames for live and replay windows deterministically for the same inputs.

A6. CONTROL PANEL CONTRACT (DESKTOP)
- Requires master password to unlock controls.
- Displays feed/storage/rotation/frame health and exact Tailscale URLs.
- Can Start/Stop, Restart collector, Switch market/symbol (collector-only restart).
- Switching does not delete previous data and writes into correct per-source folders.

A7. WEB CONTROL CONTRACT (IPAD VIA TAILSCALE)
- Accessible at http://<tailscale-ip>:8000/
- Requires password login once; session cookie persists.
- Exposes status + controls + “tail last N errors” view.
- No unauthenticated /status endpoint exists.

A8. UNINSTALL CONTRACT
- Uninstall wizard removes tasks/services, firewall rules, shortcuts/startup entries, program files.
- Prompts for optional deletion of C:\DataHub data.
- After uninstall, no background process remains.

A9. DIAGNOSTICS CONTRACT
- Append-only error ledger exists and is visible in authenticated web control.
- Errors are timestamped and include module context.

====================================================================
DELIVERY ARTIFACTS (REQUIRED)
====================================================================
1) QuantDesk_DataHub_v1.2_<build>.zip containing:
- Installer (Windows GUI wizard launcher)
- All runtime modules (C#/.NET)
- Desktop Control Panel UI (Windows desktop app)
- Uninstall Wizard
- Documentation (Runbook)
2) Build manifest:
- Version string
- Ports (8000/8010)
- Frame cadence (200 ms)
- Retention (30 days UTC)
- Storage root (C:\DataHub)
- Confirmation: "NO PYTHON USED"
3) Operator runbook:
- Install steps
- Verification steps (A1–A9)
- Troubleshooting checklist (common failure modes)
- BIOS guidance for “Restore on AC power loss”

====================================================================
CHANGE CONTROL
====================================================================
Any change to:
- ports, binding rules, retention window, file formats, folder hierarchy, auth model,
  module responsibilities, or the "NO PYTHON / .NET-only" decision
requires a version bump and re-validation of acceptance tests A1–A9.

====================================================================
SIGNATURE
====================================================================
Ava — GPT-5.2 Thinking (ChatGPT)
Signed: 2026-02-02 (Europe/Bratislava)

====================================================================
ADDENDUM v1.2 — OFFICIAL MEXC SPOT PROTOBUF (C#) + FIRST-INSTALL CONNECTIVITY
====================================================================

A) OFFICIAL SPOT PROTOBUF (C# GENERATION; NO PYTHON)
- The installer wizard MUST automatically obtain the official MEXC Spot V3 protobuf
  .proto definitions from the public repository:
    mexcdevelop/websocket-proto
- The installer MUST compile these .proto files into C# .cs source files using protoc
  with:
    --csharp_out=<install_root>\app\ProtoGen\
  (Generated code MUST come from official .proto; no handcrafted schemas.)
- The delivered runtime MUST decode Spot WS payloads using the generated C# protobuf
  classes (Google.Protobuf runtime), not handcrafted parsing.

B) AUTOMATIC CONNECTION ESTABLISHMENT (INSTALL-TIME VALIDATION)
- During installation, the wizard MUST validate that the selected market
  (MEXC Futures or MEXC Spot) and selected symbol can be connected to.
- Validation MUST include receiving at least one depth update and at least
  one trade update for the chosen symbol after subscribe/resubscribe.

C) SYMBOL CONNECTIONS / CHANNEL STRINGS (LOCKED BEHAVIOR)
- Futures: subscribe via JSON method names (sub.depth, sub.deal) with symbol
  formatted like BTC_USDT.
- Spot: subscribe via channel strings formatted like:
    spot@public.aggre.depth.v3.api.pb@100ms@BTCUSDT
    spot@public.aggre.deals.v3.api.pb@100ms@BTCUSDT
  with symbol formatted without underscore (BTCUSDT).

D) REMEDIATION COMMITMENT (NON-LEGAL)
- If the delivered build fails the stated acceptance gates on first install
  (assuming internet access is available during install and the target OS meets
  the stated requirements), the next deliverable will be a corrected full ZIP
  replacement plus updated manual and updated contract.

E) BOOKMAP PARITY STATEMENT (SCOPE-TRUE)
- DataHub guarantees deterministic capture + replay of depth and trades and
  frame delivery for the later PWA. Achieving visual/UX parity with Bookmap
  on the PWA also requires implementing the PWA’s internal rendering and
  aggregation algorithms per the Heatmap spec; DataHub is the data substrate.

F) INSTALLER SMOKE TEST (LOCKED)
- The installer MUST run a smoke test that verifies WS connectivity for the
  configured market+symbol by receiving at least one depth update and one
  trade update after subscription.
